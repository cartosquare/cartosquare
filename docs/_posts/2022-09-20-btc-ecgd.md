---
title: 椭圆曲线加密算法
published: true
---

## 数学基础

### 有限域（Finite Fields)

给定一组有限个数的数的集合，定义加法和乘法两种操作满足以下条件，称为有限域：

* 如果a和b在集合内，$a+b$和$a \cdot b$也在集合内。这个特性也成为闭包。
* 0存在于集合内，并且$a+0=a$。这个特性称为加法不变性。
* 1存在于集合内，并且$a \cdot 1=a$。这个特性称为乘法不变性。
* 如果a在集合内，定义负号操作，那么$-a$一定也在集合内，且 $a+(-a)=0$。这个特性称为加法的逆。
* 如果a在集合内，并且不为0, 定义指数操作，使得$a^{-1}$也在集合内，且$a \cdot a^{-1}=1$

#### 定义

* 有限域用符号F表示
* 有限域内元素的个数称为有限域的秩。在后面我们会看到，秩为质数的有限域十分有用，因为这个域乘以任何一个大于0数还是本身。
* 一个例子：$F_{11} = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10}$

#### 取模运算

取模运算可以用来构造一个满足以上条件的有限域。

* 定义加法：$a +_f b = (a + b) \mod p$。其中$+_f$表示有限域下的加法操作。可以知道，如果$a \in F$, 那么 $-_fa$ = (-a) mod p$ 也在集合内.
* 定义减法：$a -_f b = (a - b) \mod p$。
* 定义乘法：$a \cdot_f b = a +_f a +_f a +_f ...(总共b个a)... +_f a = (a \cdot b) \mod p$
* 费马小定理：$n^{(p-1)} \mod p = 1$，其中p为质数，n>0。该定理可以利用秩为质数的有限域不论乘以哪个大于0的数n都相等来证明（见文末附录）。
* 定义除法：$a \div_fb = a \cdot_f (1/b) = a \cdot_f b^{-1}$
* 根据费马小定理，有 $b^{-1} = b^{-1} \cdot_f 1 = b^{-1} \cdot_f b^{(p-1)} = b^{p-2}$
* 所以 $a \div_f b = a \cdot_f b^{-1} = a \cdot_f b^{p-2}$
* 定义指数运算：$a^b=a^{b \mod (p - 1)} = a \cdot_f a \cdot_f a ... + \cdot_f a$。注意，这里b有可能是负数，所以要先对p-1取模（依据费马小定理，如果是负数的话，可以一直加p-1直到变为正数, 因为 $n^{(p-1)}=1$可以免费乘)。

### 椭圆曲线（Elliptic Curves）

关注下面这个椭圆曲线：

$$y^2 = x^3 + 5x + 7$$

可以看出，椭圆曲线是关于x轴对称的。

#### 点加法
定义曲线上点的加法的操作为：给定曲线上两个点，根据这两个点找到第三个点。第三个点是前两个点构成的直线和曲线的交点关于x轴的对称点。

当然，如果前两个点位置比较特殊，比如x坐标相同，或者x、y坐标都相同的话，第三个点并不存在，这些只是少数的特殊情况，可以定义结果为无穷大。

![Point Addition](/images/blogs/btc/ec_point_addition.png)

####  推导

假设：

* $P_1 = (x_1, y_1), P_2 = (x_2, y_2), P_3 = (x_3, y_3)$
* $P_1 + P_2 = P_3$

我们想知道$P_3$如何计算。

首先，根据P1和P2位于一条直线的事实，假设$x_1$ 不等于$x_2$, 有：

* $s = (y_2 - y_1) / (x_2 - x_1)$
* $y = s(x - x_1) + y_1$

根据直线P1P2和椭圆曲线相交，有：

* $y^2 = x^3 + ax + b$
* $y^2 = (s(x - x_1) + y_1)^2 = x^3 + ax + b$

得到下面这个多项式方程：

* $x^3 - s^2x^2 + (a + 2s^2x_1 - 2sy_1)x + b - s^2x_1^2 + 2sx_1y_1 - y_1^2 = 0$ <1>

另一方面，我们知道x1、x2、x3都是上面这个多项式方程的解，因此有：

* $(x - x_1)(x - x_2)(x - x_3) = 0$
* $x^3 - (x_1 + x_2 + x_3)x^2 + (x_{1}x_{2} + x_{1}x_{3} + x_{2}x_{3})x - x_{1}x_{2}x_{3} = 0$ <2>

根据 <1>和<2>, 二次项前的系数需要相同，因此有$：

* $-s^2 = -(x_1 + x_2 + x_3)$
* $x_3 = s^2 - x_1 - x_2$
* $y_3 = -(s(x_3 - x_1) + y_1) = s(x_1 - x_3) - y_1$

注意到P3是直线P1P2和曲线的交点关于x轴的对称点。